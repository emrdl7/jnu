(function($){"use strict";var $menuTree=$("#menuTree"),$menuModal=$("#newMenuModal"),_selectMenuForNew=null,$newMenuForm=$("#newMenuForm"),_editFromContext=false,_URI=new URI,$menuFormContainer=$("#menuFormContainer");function menuval(node,key){return _.has(node,"original")?node.original[key]:node[key]}function nodeText(node){var level=1;var text=menuval(node,"name");if(!menuval(node,"micon"))text=text+' <b class="'+menuval(node,"micon")+'"></b>';if(!menuval(node,"use"))text="<del>"+text+"</del>";if(!menuval(node,"display"))text='<span class="text-muted">'+text+"</span>";switch(level){case 1:text='<strong class="" style="font-size:14px;">'+text+"</strong>";break;case 2:text='<strong class="">'+text+"</strong>";break}text=text+' <span class="text-muted ml-2 f-s-14">'+menuval(node,"url")+"</span>";var groupString=menuval(node,"groups");if(!_.isNull(groupString)){groupString=groupString.replace(/,?SADMIN,?/,"");if(groupString!=""){text=text+' <span class="text-muted ml-2 f-s-14"><i class="fal fa-lock"></i> '+groupString+"</span>"}}return text}function makeNode(menu){var node={id:menu.seq,name:menu.name,parent:menu.parent?menu.parent:"#",children:menu.childCount>0,url:menu.url,text:menu.name,type:menu.type,sort:menu.sort,display:menu.display,use:menu.use,micon:menu.icon,groups:menu.groups};node.text=nodeText(node);return node}$menuTree.jstree({plugins:["contextmenu","dnd","types","json_data"],types:{"#":{max_depth:3},READY:{icon:"far fa-times-circle"},CONTENTS:{icon:"fal fa-file-alt"},BOARD:{icon:"fal fa-edit"},MODULE:{icon:"far fa-cog"},REDIRECT:{icon:"fas fa-arrow-right"},LINK:{icon:"fal fa-external-link"},IFRAME:{icon:"fal fa-browser"}},core:{multiple:false,dblclick_toggle:false,themes:{name:"proton",responsive:true},check_callback:function(op,node,parent,pos,more){if(op=="edit"&&!_editFromContext)return false;if(op=="move_node"){if(node.parent!=parent.id){var urls=[];_.each(parent.children,function(id){urls.push($menuTree.jstree(true).get_node(id).original.url)});return!_.includes(urls,node.original.url)}}return true},data:{dataType:"json",url:function(node){if(node.id==="#"||node.id==="/"){return _URI.clone().setSearch({act:"list",site:_SITE.id,_out:"json"}).href()}else{return _URI.clone().setSearch({act:"list",site:_SITE.id,parent:node.id,_out:"json"}).href()}},data:function(node){},dataFilter:function(data,b){data=JSON.parse(data);var menus=[];_.each(data.menus,function(menu){menus.push(makeNode(menu))});return JSON.stringify(menus)}}},contextmenu:{select_node:false,items:function(node){var menus={};var tree=$menuTree.jstree(true);var root_max_depth=tree.get_rules("#").max_depth;var current_level=(tree.get_path(node,"^").match(/\^/g)||[]).length;menus.create={label:"하위 메뉴 추가",title:'"'+node.original.name+'" 에 자식 메뉴를 추가 합니다.',action:function(data){_selectMenuForNew=tree.get_node(data.reference);$("#modal-parent-info").html(tree.get_path(_selectMenuForNew," &gt; "));$("#modal-parent").val(_selectMenuForNew.id=="#"?"":_selectMenuForNew.id);$menuModal.modal({})},_disabled:!node.state.loaded||current_level>=root_max_depth,icon:"fas fa-plus"};menus.rename={label:"메뉴명 변경",title:"선택한 메뉴의 이름을 변경합니다.",icon:"fal fa-edit",action:function(data){var renameMenu=tree.get_node(data.reference),oldText=renameMenu.original.name;_editFromContext=true;tree.edit(renameMenu,renameMenu.original.name,function(node,success){if(success){$.post(_URI.path(),{act:"index",cmd:"setValue",seq:renameMenu.id,_out:"json",field:"name",value:node.text},function(data,stat,xhr){node.original.name=data.menu.name;tree.rename_node(node,"");tree.rename_node(node,nodeText(node))})}});_editFromContext=false}};menus.contents={label:"콘텐츠 관리 ("+menuval(node,"contentsCount")+")",title:"선택한 메뉴의 관련 콘텐츠를 관리합니다.",separator_before:true,_disabled:false,icon:"fal fa-file-alt",action:function(data){popup({act:"contents",menu:node.id,height:500})}};if(node.parent!="#"||menuval(node,"url")!="index"){menus.display={label:node.original.display?"표시 안함":"표시함",title:"메뉴의 표시 여부를 설정 합니다.",_disabled:node.id=="/"||node.id=="#",icon:node.original.display?"fal fa-eye-slash":"fal fa-eye",action:function(data){$.post(_URI.path(),{act:"index",cmd:"toggle",seq:node.id,field:"display",_out:"json"},function(data,stat,xhr){node.original.display=data.menu.display;loadMenuForm(node);tree.rename_node(node,"");tree.rename_node(node,nodeText(node))},"json")}};menus.use={label:menuval(node,"use")?"사용 안함":"사용함",title:"메뉴의 사용 여부를 설정 합니다.",_disabled:node.id=="/"||node.id=="#",icon:menuval(node,"use")?"fal fa-times":"fal fa-circle",action:function(data){$.post(_URI.path(),{act:"index",cmd:"toggle",seq:node.id,field:"use",_out:"json"},function(data,stat,xhr){node.original.use=data.menu.use;loadMenuForm(node);tree.rename_node(node,"");tree.rename_node(node,nodeText(node))},"json")}};menus.del={label:"메뉴 삭제",titel:"선택한 메뉴를 삭제합니다.",action:function(data){var selects=tree.get_selected(true),confirmText="삭제하면 하위 메뉴도 모두삭제 되며, 복구할 수 없습니다.\n";if(selects.length==1){confirmText+='선택한 메뉴 "'+selects[0].original.name+'" 을(를) 삭제하시겠습니까 ?'}else if(selects.length>1){confirmText+="선택한 메뉴들 "+selects.length+"개를 삭제하시겠습니까 ?"}else{swal("선택 없음","삭제할 메뉴를 선택해야 합니다","warning");return}swal({title:"삭제하시겠습니까 ?",text:confirmText,type:"warning",showCancelButton:true,cancelButtonText:"아니오",confirmButtonClass:"btn-danger",confirmButtonText:"예, 삭제합니다",closeOnConfirm:false,showLoaderOnConfirm:true},function(){var seqs=[];_.each(selects,function(node){seqs.push(node.id)});$.post(_URI.path(),{act:"index",cmd:"dels",_out:"json",seq:seqs},function(data,stat,xhr){unloadMenuForm();tree.delete_node(selects);swal.close()},"json")})},separator_before:true,_disabled:node.id=="/"||node.id=="#",icon:"fas fa-trash",shortcut:46,shortcut_label:"Delete"}}return menus}}});$menuModal.on("shown.bs.modal",function(){$("#modal-name").trigger("focus")});$newMenuForm.on("ajax-success",function(e,data,status,xhr,$form){$form.find("input[type=text]").clearFields();if($("#continueAdd").prop("checked")){$("#modal-name").trigger("focus")}else{$menuModal.modal("hide")}var tree=$menuTree.jstree(true);var createdId=tree.create_node(_selectMenuForNew,makeNode(data.menu),"last",function(new_menu){tree.deselect_all(false);tree.select_node(new_menu,false,false)},true)});function unloadMenuForm(){$menuFormContainer.empty()}function loadMenuForm(node){$menuFormContainer.load(_URI.path(),{act:"index",cmd:"edit",site:_SITE.id,seq:node.id,_out:"body"},initUI)}function fullUrl(node){var tree=$menuTree.jstree(true);var url=menuval(node,"url");var parent=tree.get_parent(node);if(parent=="#")return"/"+url;return fullUrl(tree.get_node(parent))+"/"+url}$menuTree.bind("dblclick.jstree",function(e){var tree=$menuTree.jstree(true);var selects=tree.get_selected(true);var node=selects[0];var url=_SITE.prefix+fullUrl(node)+_SITE.suffix;console.log(fullUrl(node),url);window.open(url)});$menuTree.on("select_node.jstree",function(e,select){var node=select.node,selected_ids=select.selected;if(node.id!="/")loadMenuForm(node)});$menuTree.on("deselect_all.jstree deselect_node.jstree",function(){unloadMenuForm();$menuFormContainer.html('<div class="alert alert-info d-none d-lg-block"><i class="fa fa-long-arrow-left"></i> 메뉴를 선택하면 메뉴를 편집할 수 있습니다.</div>')});$menuTree.on("move_node.jstree",function(e,data){var tree=$menuTree.jstree(true),node=data.node,old_parent=data.old_parent,new_parent=data.parent,old_pos=data.old_position,new_pos=data.position;holdTree();$.ajax({async:false,url:_URI.path(),method:"POST",dataType:"json",data:{cmd:"move",seq:node.id,newParent:new_parent=="#"?"":new_parent,newPosition:new_pos+1,_out:"json"},success:function(){try{if(tree.is_parent(old_parent))tree.refresh_node(old_parent);if(old_parent!=new_parent&&tree.is_parent(new_parent))tree.refresh_node(new_parent);releaseTree()}catch(err){console.error(err)}}})});$menuTree.on("copy_node.jstree",function(e,data){var tree=$menuTree.jstree(true);holdTree();$.post(_URI.path(),{cmd:"copy",seq:data.original.id,newParent:data.parent=="#"?"":data.parent,newPos:data.position+1,_out:"json"},function(){if(tree.is_parent(data.old_parent))tree.refresh_node(data.old_parent);if(data.old_parent!=data.parent&&tree.is_parent(data.parent))tree.refresh_node(data.parent);releaseTree()})});$(".add-to-top").on("click",function(){_selectMenuForNew="#";$("#modal-parent-info").html("최상위 메뉴");$("#modal-parent").val("");$menuModal.modal({})});$("#expandAll").on("click",function(){$menuTree.jstree(true).open_all(null,300)});$("#collapseAll").on("click",function(){var root=$menuTree.jstree(true).get_node("/");if(!root.children)return;_.each(root.children,function(id){$menuTree.jstree(true).close_all(id,100)})});function holdTree(){$menuTree.waitMe({effect:"bounce",text:"처리중",bg:"rgba(255,255,255,0.8)",color:"#000",maxSize:"",waitTime:-1,textPos:"vertical",fontSize:"20px",source:"",onClose:function(){}})}function releaseTree(){$menuTree.waitMe("hide")}window.endEditMenu=function(parent){var tree=$menuTree.jstree(true);tree.deselect_all();tree.refresh_node(parent?parent:"#")};window.unloadAndDeselect=function(){var tree=$menuTree.jstree(true);tree.deselect_all();unloadMenuForm()}})(jQuery);